<!DOCTYPE html>
<html lang="de"
      x-data="{ open: true, mobileOpen: false }"
      x-bind:class="{ 'dark': $store.theme.darkMode, 'overflow-hidden': $store.modal.active || mobileOpen }">
<head>
  <meta charset="utf-8">
  <title>{% block title %}AlphaRequestManager{% endblock %}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- FOUC-Fix: Dark Mode gleich beim Laden anwenden -->
  <script>
    (function () {
      try {
        var t = localStorage.getItem('theme');
        var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (t === 'dark' || (!t || t === 'system') && prefersDark) {
          document.documentElement.classList.add('dark');
        }
      } catch (e) {}
    })();
  </script>

  <!-- Schrift: Inter -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <!-- Tailwind & Alpine.js -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Icons: Lucide -->
  <script defer src="https://unpkg.com/lucide@0.454.0"></script>
  <script>
    window.addEventListener('DOMContentLoaded', () => lucide.createIcons());
  </script>

  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        fontFamily: { sans: ['Inter', 'sans-serif'] },
        extend: {
          colors: {
            sidebar: '#3EAAB8',
            sidebarHover: '#32919E',
            header: '#FFFFFF',
            headerDark: '#1E2327',
            content: '#F3F4F6',
            contentDark: '#0B1014', /* schöner dunkler Hintergrund */
            primary: '#3EAAB8',
            primaryHover: '#2B7D89',
            muted: '#6B7280',
            danger: '#EF4444',
            cardDark: '#1B2026',   /* Kartenfarbe Darkmode */
            fieldDark: '#242A31'   /* Inputfarbe Darkmode */
          },
          boxShadow: {
            'elevated': '0 10px 25px -5px rgba(0,0,0,0.15), 0 8px 10px -6px rgba(0,0,0,0.08)'
          }
        }
      }
    };
  </script>

  <!-- Alpine Stores: Theme & Modal -->
  <script>
    document.addEventListener('alpine:init', () => {
      const media = window.matchMedia('(prefers-color-scheme: dark)');
      Alpine.store('theme', {
        mode: 'system',
        darkMode: false,
        _lastManual: localStorage.getItem('theme_manual') || 'light',
        init() {
          const saved = localStorage.getItem('theme');
          this.mode = saved || 'system';
          const handler = (e) => { if (this.mode === 'system') this.apply(e.matches); };
          media.addEventListener ? media.addEventListener('change', handler) : media.addListener(handler);
          this.apply(media.matches);
        },
        apply(prefersDarkNow) {
          const prefers = typeof prefersDarkNow === 'boolean' ? prefersDarkNow : media.matches;
          this.darkMode = this.mode === 'system' ? prefers : this.mode === 'dark';
        },
        toggleSystem() {
          if (this.mode === 'system') {
            this.setMode(this._lastManual);
          } else {
            this._lastManual = this.mode;
            localStorage.setItem('theme_manual', this._lastManual);
            this.setMode('system');
          }
        },
        setMode(mode) {
          this.mode = mode;
          localStorage.setItem('theme', mode);
          this.apply();
        },
        enable()  { this._lastManual = 'dark';  localStorage.setItem('theme_manual','dark');  this.setMode('dark'); },
        disable() { this._lastManual = 'light'; localStorage.setItem('theme_manual','light'); this.setMode('light'); }
      });
      Alpine.store('modal', { active: false });
    });
  </script>

  <!-- Globale Styles -->
  <style>
    [x-cloak]{ display:none !important; }
    html, body { height: 100%; margin: 0; padding: 0; }
    @media (prefers-reduced-motion: reduce){ *{ animation:none!important; transition:none!important } }

    /* === Farb-Token für Light/Dark === */
    :root{
      --bg:            #F3F4F6;
      --text:          #0F172A;
      --card-bg:       #FFFFFF;
      --field-bg:      #FFFFFF;
      --border:        #E5E7EB;
      --muted:         #6B7280;
      --ring:          0 0 0 4px rgba(62,170,184,.25);
    }
    .dark{
      --bg:            #0B1014;
      --text:          #E5E7EB;
      --card-bg:       #1B2026;
      --field-bg:      #242A31;
      --border:        #404854;
      --muted:         #9CA3AF;
    }

    /* === Utility-Klassen === */
    .modal-panel{
      background-color: var(--card-bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      box-shadow: 0 20px 50px -20px rgba(0,0,0,.35);
    }
    .card{
      background-color: color-mix(in oklab, var(--card-bg) 96%, transparent);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
    }
    .card--pad{ padding: 1rem; }
    .field{
      background-color: var(--field-bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: .5rem;
      padding: .5rem .75rem;
    }
    .field:focus{ outline: none; box-shadow: var(--ring); border-color: transparent; }

    body{ background: var(--bg); color: var(--text); }
  </style>

  {% block head %}{% endblock %}
</head>

<body class="flex h-screen bg-content dark:bg-contentDark text-gray-900 dark:text-gray-100 font-sans">

  <!-- Skip Link -->
  <a href="#main"
     class="sr-only focus:not-sr-only focus:fixed focus:top-2 focus:left-2 bg-white dark:bg-gray-900 text-sm px-3 py-1 rounded shadow z-50">
    Zum Inhalt springen
  </a>

  <!-- Sidebar -->
  <aside
    :class="open ? 'w-72' : 'w-24'"
    class="hidden md:flex h-[calc(100vh-1.5rem)] m-3 flex-col flex-shrink-0 transition-all duration-300 ease-in-out
           bg-sidebar/95 dark:bg-[#2D8E9A] text-white rounded-2xl shadow-elevated ring-1 ring-white/10 overflow-hidden"
    role="complementary" aria-label="Seitenleiste Navigation">

    <!-- Brand -->
    <div class="flex items-center gap-3 px-4 py-4 border-b border-white/10">
      <button
        @click="open = !open"
        class="p-2 rounded-lg bg-white/10 hover:bg-white/20 transition"
        :aria-expanded="open.toString()"
        aria-controls="sidebar-nav-desktop"
        title="Sidebar ein-/ausklappen">
        <i data-lucide="chevrons-left-right" class="w-5 h-5"></i>
      </button>
      <span x-show="open" x-cloak class="text-2xl font-bold tracking-tight whitespace-nowrap">AlphaRequest</span>
    </div>

    <!-- Nav -->
    <nav id="sidebar-nav-desktop" class="flex-1 px-3 py-3 space-y-1">
      {% set is_dash  = request.url.path=='/dashboard' %}
      {% set is_tix   = request.url.path=='/pruefung' %}
      {% set is_set   = request.url.path.startswith('/admin/settings') %}

      <!-- Dashboard -->
      <a href="/dashboard"
         aria-current="{{ 'page' if is_dash else 'false' }}"
         class="group relative flex items-center gap-3 px-3 py-2 rounded-xl transition
                hover:bg-white/10 {{ 'bg-white/15' if is_dash else '' }}">
        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
        <span x-show="open" x-cloak class="text-sm font-medium">Übersicht</span>
      </a>

      {% if is_admin %}
      <!-- Tickets -->
      <a href="/pruefung"
         aria-current="{{ 'page' if is_tix else 'false' }}"
         class="group relative flex items-center gap-3 px-3 py-2 rounded-xl transition
                hover:bg-white/10 {{ 'bg-white/15' if is_tix else '' }}">
        <i data-lucide="ticket" class="w-5 h-5"></i>
        <span x-show="open" x-cloak class="text-sm font-medium">Tickets</span>
      </a>

            <a href="/analytics"
         aria-current="{{ 'page' if is_tix else 'false' }}"
         class="group relative flex items-center gap-3 px-3 py-2 rounded-xl transition
                hover:bg-white/10 {{ 'bg-white/15' if is_tix else '' }}">
        <i data-lucide="chart-area" class="w-5 h-5"></i>
        <span x-show="open" x-cloak class="text-sm font-medium">Analytics</span>
      </a>

      <!-- Admin · Settings -->
      <a href="/admin/settings"
         aria-current="{{ 'page' if is_set else 'false' }}"
         class="group relative flex items-center gap-3 px-3 py-2 rounded-xl transition
                hover:bg-white/10 {{ 'bg-white/15' if is_set else '' }}">
        <i data-lucide="settings" class="w-5 h-5"></i>
        <span x-show="open" x-cloak class="text-sm font-medium">Admin · Settings</span>
      </a>
      {% endif %}
    </nav>
  </aside>

  <!-- Mobile Sidebar -->
  <div class="md:hidden">
    <div x-show="mobileOpen" x-cloak
         @click="mobileOpen = false"
         class="fixed inset-0 bg-black/40 backdrop-blur-sm z-40"></div>
    <aside x-show="mobileOpen" x-cloak
           class="fixed inset-y-0 left-0 w-80 bg-sidebar/95 dark:bg-[#2D8E9A] text-white z-50 shadow-2xl
                  rounded-r-2xl ring-1 ring-white/10 overflow-hidden">
      <div class="flex items-center justify-between px-4 py-4 border-b border-white/10">
        <span class="text-xl font-bold">AlphaRequest</span>
        <button @click="mobileOpen = false" class="p-2 rounded-lg bg-white/10 hover:bg-white/20">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <nav class="px-3 py-3 space-y-1">
        <a href="/dashboard" class="group flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-white/10">
          <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
          <span class="text-sm font-medium">Übersicht</span>
        </a>
        {% if is_admin %}
        <a href="/pruefung" class="group flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-white/10">
          <i data-lucide="ticket" class="w-5 h-5"></i>
          <span class="text-sm font-medium">Tickets</span>
        </a>
        <a href="/admin/settings" class="group flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-white/10">
          <i data-lucide="settings" class="w-5 h-5"></i>
          <span class="text-sm font-medium">Admin · Settings</span>
        </a>
        {% endif %}
        <a href="/logout" class="group flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-white/10">
          <i data-lucide="log-out" class="w-5 h-5"></i>
          <span class="text-sm font-medium">Logout</span>
        </a>
      </nav>
    </aside>
  </div>

  <!-- Main Column -->
  <div class="flex-1 flex flex-col">

    <!-- Topbar -->
    <header class="mx-3 mt-3 rounded-2xl px-6 py-4 bg-header dark:bg-headerDark border border-gray-200 dark:border-gray-700 shadow-sm flex items-center justify-between">
      <button @click="mobileOpen = true"
              class="md:hidden p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition"
              aria-label="Mobile Navigation öffnen">
        <i data-lucide="menu" class="w-6 h-6 text-primary"></i>
      </button>
      <div class="text-sm text-muted"></div>
      <div class="flex items-center gap-2">
        <button @click="$store.theme.toggleSystem()" class="p-2 rounded-lg hover:bg-primaryHover/20 transition" aria-label="Theme umschalten">
          <i :data-lucide="'moon'" class="w-6 h-6 text-primary"></i>
        </button>
        <button @click="$dispatch('open-profile')" aria-label="Profil öffnen" class="p-2 rounded-lg hover:bg-primaryHover/20 transition">
          <i data-lucide="user" class="w-6 h-6 text-primary"></i>
        </button>
        <button @click="$dispatch('open-settings')" aria-label="Einstellungen öffnen" class="p-2 rounded-lg hover:bg-primaryHover/20 transition">
          <i data-lucide="settings" class="w-6 h-6 text-primary"></i>
        </button>
        <a href="/logout" class="p-2 rounded-lg hover:bg-primaryHover/20 transition" aria-label="Logout">
          <i data-lucide="log-out" class="w-6 h-6 text-primary"></i>
        </a>
      </div>
    </header>

    <!-- Main Content -->
    <main id="main" class="flex-1 overflow-auto m-3">
      <div class="rounded-2xl bg-header dark:bg-cardDark border border-gray-200 dark:border-gray-700 p-6">
        {% block content %}{% endblock %}
      </div>
    </main>
  </div>

  <!-- Modals -->
  {% include "partials/profile_modal.html" %}
  {% include "partials/settings_modal.html" %}

  <!-- Session Timeout -->
  <script>
    (function () {
      const timeout = {{ SESSION_TIMEOUT }} * 1000;
      if (!timeout) return;
      let timer = setTimeout(redirect, timeout);
      function reset() {
        clearTimeout(timer);
        timer = setTimeout(redirect, timeout);
      }
      function redirect() { window.location.href = '/login'; }
      ['click','mousemove','keydown','scroll','touchstart'].forEach(evt => {
        document.addEventListener(evt, reset, { passive: true });
      });
    })();
  </script>
</body>
</html>
