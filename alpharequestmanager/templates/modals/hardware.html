<!-- === Hardware-Setup-Assistent (vollst√§ndig mit Namens-/Adress-Aufteilung & Regeln) === -->
<div x-show="ticketType === 'Hardwarebestellung' && showTicketModal" x-cloak
     @close-hw.window="showTicketModal = false">

  <!-- Overlay -->
  <div class="fixed inset-0 bg-black/40 backdrop-blur-sm z-40" @click="$dispatch('close-hw')"></div>

  <!-- Wrapper -->
  <div class="fixed inset-0 z-50" @keydown.escape.window="$dispatch('close-hw')">
    <div class="min-h-screen flex items-center justify-center px-4 py-8">

      <!-- Panel: adaptive H√∂he, nur Body scrollt -->
      <div class="modal-panel w-full max-w-5xl relative max-h-[85vh] h-auto flex flex-col"
           x-data="hwAssistant()"
           x-init="init()"
           x-on:close-hw.window="resetAll()">

        <!-- Header -->
        <div class="px-6 pt-5 pb-3 flex items-start justify-between">
          <div>
            <h3 class="text-lg font-semibold">üõ†Ô∏è Hardware-Setup-Assistent</h3>
            <p class="text-sm text-muted">Schritt f√ºr Schritt zur Bestellung.</p>
          </div>
          <button @click="$dispatch('close-hw')" class="p-1 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" aria-label="Schlie√üen">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <!-- Stepper + Progress -->
        <div class="px-6 pb-3">
          <div class="flex items-center gap-2 text-[12px] overflow-x-auto">
            <template x-for="(s, i) in steps" :key="i">
              <div class="flex items-center gap-2">
                <div class="px-2 py-0.5 rounded-md border"
                     :class="current===i
                              ? 'bg-primary text-white border-primary'
                              : (i<current ? 'bg-green-600 text-white border-green-600'
                                           : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 border-gray-200 dark:border-gray-600')"
                     x-text="s"></div>
                <div x-show="i < steps.length-1" class="text-muted">‚Ä∫</div>
              </div>
            </template>
          </div>
          <div class="mt-2 h-2 rounded bg-gray-200 dark:bg-gray-700">
            <div class="h-2 rounded bg-primary transition-all" :style="`width:${progress}%`"></div>
          </div>
        </div>

        <!-- Fehler -->
        <template x-if="error">
          <div class="px-6 pb-2">
            <div class="card card--pad bg-red-50 dark:bg-red-900/30 border border-red-400 text-red-800 dark:text-red-200">
              <span x-text="error"></span>
            </div>
          </div>
        </template>

        <!-- BODY -->
        <div class="px-6 pb-4 overflow-auto">
          <form x-ref="form" method="post" action="/tickets" @submit.prevent="submit()" @keydown.enter.prevent>
            <input type="hidden" name="title" value="Hardwarebestellung">
            <textarea x-ref="desc" name="description" class="hidden"></textarea>

            <div class="grid grid-cols-1 lg:grid-cols-[2fr_1fr] gap-6">
              <!-- Linke Spalte -->
              <div class="space-y-5">
                <!-- Schritt 0: Mitarbeitertyp -->
                <section class="card card--pad" x-show="current===0">
                  <h4 class="font-semibold mb-2">üë§ Mitarbeitertyp</h4>
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700"
                           :class="data.mitarbeiterTyp==='Bestandsmitarbeiter' ? 'ring-2 ring-primary' : ''">
                      <input type="radio" name="typ" value="Bestandsmitarbeiter" x-model="data.mitarbeiterTyp">
                      <span>Bestandsmitarbeiter</span>
                    </label>
                    <label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700"
                           :class="data.mitarbeiterTyp==='Neuer Mitarbeiter' ? 'ring-2 ring-primary' : ''">
                      <input type="radio" name="typ" value="Neuer Mitarbeiter" x-model="data.mitarbeiterTyp">
                      <span>Neuer Mitarbeiter</span>
                    </label>
                  </div>
                </section>

                <!-- Schritt 1: Basisdaten -->
                <section class="card card--pad" x-show="current===1">
                  <h4 class="font-semibold mb-2">üìá Basisdaten</h4>
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                      <label class="block mb-1 text-sm">Vorname</label>
                      <input class="field w-full" x-model="data.vorname" required>
                      <p class="mt-1 text-xs text-muted">Hinweis: Angaben der Person, f√ºr die bestellt wird.</p>
                    </div>
                    <div>
                      <label class="block mb-1 text-sm">Nachname</label>
                      <input class="field w-full" x-model="data.nachname" required>
                    </div>
                    <div>
                      <label class="block mb-1 text-sm">Kostenstelle</label>
<input
  class="field w-full"
  x-model="data.kostenstelle"
  inputmode="numeric"
  pattern="\d+"
  autocomplete="off"
  placeholder="nur Ziffern"
  @beforeinput="if ($event.data && /\D/.test($event.data)) $event.preventDefault()"
  @input="data.kostenstelle = (data.kostenstelle || '').replace(/\D/g,'')"
  required
>
                      <p class="mt-1 text-xs text-muted">Hinweis: Kostenstelle der zu bestellenden Person.</p>
                    </div>
                    <div>
                      <label class="block mb-1 text-sm">Firma</label>
                      <!-- Ladezustand -->
                      <template x-if="companiesLoading">
                        <div class="field w-full flex items-center justify-between">
                          <span class="text-sm text-muted">Lade Firmen ‚Ä¶</span>
                          <svg class="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" opacity=".25"></circle>
                            <path d="M22 12a10 10 0 0 1-10 10" stroke="currentColor" stroke-width="4"></path>
                          </svg>
                        </div>
                      </template>
                      <!-- Fehlerzustand ‚Üí Fallback -->
                      <template x-if="!companiesLoading && companiesError">
                        <div class="space-y-1">
                          <div class="text-xs text-red-600" x-text="companiesError"></div>
                          <input class="field w-full" x-model="data.firma" placeholder="Firma manuell eingeben" required>
                        </div>
                      </template>
                      <!-- Erfolgszustand -->
                      <template x-if="!companiesLoading && !companiesError">
                        <select class="field w-full" x-model="data.firma" required>
                          <option value="">-- bitte w√§hlen --</option>
                          <template x-for="firma in companies" :key="firma">
                            <option :value="firma" x-text="firma"></option>
                          </template>
                        </select>
                      </template>
                    </div>

                    <!-- Adresse (aufgetrennt) -->
                    <div class="sm:col-span-2 grid grid-cols-1 sm:grid-cols-6 gap-3">
                      <div class="sm:col-span-3">
                        <label class="block mb-1 text-sm">Stra√üe</label>
                        <input class="field w-full" x-model="data.addr_strasse" required>
                      </div>
                      <div class="sm:col-span-1">
                        <label class="block mb-1 text-sm">Nr.</label>
                        <input class="field w-full" x-model="data.addr_nr" required>
                      </div>
                      <div class="sm:col-span-2">
                        <label class="block mb-1 text-sm">PLZ</label>
                        <input
  class="field w-full"
  x-model="data.addr_plz"
  inputmode="numeric"
  @input="data.addr_plz = (data.addr_plz || '').replace(/\D/g, '').slice(0,5)"
  placeholder="PLZ (4‚Äë oder 5‚Äëstellig)"
  required
>
                      </div>
                      <div class="sm:col-span-3">
                        <label class="block mb-1 text-sm">Stadt</label>
                        <input class="field w-full" x-model="data.addr_stadt" required>
                      </div>
                      <div class="sm:col-span-3">
                        <label class="block mb-1 text-sm">Name am T√ºrschild (optional)</label>
                        <input class="field w-full" x-model="data.addr_tuerschild" placeholder="z. B. AlphaConsult">
                      </div>
                    </div>

                    <div class="sm:col-span-2">
                      <label class="block mb-1 text-sm">Lieferung bis</label>
                      <input type="date" class="field w-full" x-model="data.lieferungBis" required>
                      <small class="text-xs text-muted">mind. 7 Tage Vorlaufzeit</small>
                    </div>
                  </div>
                </section>

                <!-- Pfad A: Bestandsmitarbeiter -->
                <template x-if="data.mitarbeiterTyp==='Bestandsmitarbeiter'">
                  <div>
                    <section class="card card--pad" x-show="current===2">
                      <h4 class="font-semibold mb-2">üß∞ Auswahl &amp; Grund</h4>

                      <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center gap-2 cursor-pointer" @mouseenter="hover('Notebook')" @mouseleave="hover(null)">
                          <input type="checkbox" x-model="data.artikel.Notebook"><span>Notebook</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer" @mouseenter="hover('MiniPC')" @mouseleave="hover(null)">
                          <input type="checkbox" x-model="data.artikel.MiniPC"><span>MiniPC</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer" @mouseenter="hover('Dockingstation')" @mouseleave="hover(null)">
                          <input type="checkbox" x-model="data.artikel.Dockingstation"><span>Dockingstation</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer" @mouseenter="hover('MausUndTastatur')" @mouseleave="hover(null)">
                          <input type="checkbox" x-model="data.artikel.MausUndTastatur"><span>Maus &amp; Tastatur</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer" @mouseenter="hover('Headset')" @mouseleave="hover(null)">
                          <input type="checkbox" x-model="data.artikel.Headset"><span>Headset</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer" @mouseenter="hover('Webcam')" @mouseleave="hover(null)">
                          <input type="checkbox" x-model="data.artikel.Webcam"><span>Webcam</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer" @mouseenter="hover('HandyUndSim')" @mouseleave="hover(null)">
                          <input type="checkbox" x-model="data.artikel.HandyUndSim"><span>Handy &amp; SIM</span>
                        </label>
                      </div>

                      <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <label class="flex items-center gap-2 cursor-pointer" @mouseenter="hover('Monitor')" @mouseleave="hover(null)">
                          <input type="checkbox" x-model="data.monitor.benoetigt"><span>Monitor ben√∂tigt</span>
                        </label>
                        <div x-show="data.monitor.benoetigt">
                          <label class="block mb-1 text-sm">Anzahl</label>
                          <select class="field w-full" x-model.number="data.monitor.anzahl"
                                  @mouseenter="hover('Monitor')" @mouseleave="hover(null)">
                            <option value="1">1</option>
                            <option value="2">2</option>
                          </select>
                        </div>
                      </div>

                      <div class="mt-4">
                        <label class="block mb-1 text-sm">Grund der Neubestellung <span class="text-red-600">*</span></label>
                        <textarea class="field w-full" rows="3"
                                  x-model="data.grundBestellung"
                                  placeholder="z. B. Defekt, Erweiterung, Ersatz ‚Ä¶" required></textarea>
                      </div>
                    </section>

                    <section class="card card--pad" x-show="current===3">
                      <h4 class="font-semibold mb-2">üßæ Zusammenfassung</h4>
                      <div class="text-sm space-y-2">
                        <p><strong>Name:</strong> <span x-text="fullName"></span></p>
                        <p><strong>Firma:</strong> <span x-text="data.firma"></span> ¬∑ <strong>Kostenstelle:</strong> <span x-text="data.kostenstelle"></span></p>
                        <p><strong>Lieferadresse:</strong> <span x-text="assembledAddress"></span></p>
                        <p><strong>Lieferung bis:</strong> <span x-text="data.lieferungBis"></span></p>
                        <p><strong>Artikel:</strong> <span x-text="listArtikel() || '‚Äì'"></span></p>
                        <p><strong>Monitore:</strong> <span x-text="data.monitor.benoetigt ? data.monitor.anzahl : 'keine'"></span></p>
                        <p><strong>Grund:</strong> <span x-text="data.grundBestellung"></span></p>
                      </div>
                    </section>
                  </div>
                </template>

                <!-- Pfad B: Neuer Mitarbeiter -->
                <template x-if="data.mitarbeiterTyp==='Neuer Mitarbeiter'">
                  <div>
                    <!-- 2: Bildschirme -->
                    <section class="card card--pad" x-show="current===2">
                      <h4 class="font-semibold mb-2">üñ•Ô∏è Bildschirme</h4>
                      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <label class="flex items-center gap-2 cursor-pointer" @mouseenter="hover('Monitor')" @mouseleave="hover(null)">
                          <input type="checkbox" x-model="data.monitor.benoetigt"><span>Monitor ben√∂tigt</span>
                        </label>
                        <div x-show="data.monitor.benoetigt">
                          <label class="block mb-1 text-sm">Anzahl</label>
                          <select class="field w-full" x-model.number="data.monitor.anzahl"
                                  @mouseenter="hover('Monitor')" @mouseleave="hover(null)">
                            <option value="1">1</option>
                            <option value="2">2</option>
                          </select>
                        </div>
                      </div>
                    </section>

                    <!-- 3: Ger√§t -->
                    <section class="card card--pad" x-show="current===3">
                      <h4 class="font-semibold mb-2">üíª Ger√§tetyp</h4>
                      <div class="grid grid-cols-2 gap-3">
                        <label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700"
                               :class="data.geraet==='Laptop' ? 'ring-2 ring-primary' : ''"
                               @mouseenter="hover('Notebook')" @mouseleave="hover(null)">
                          <input type="radio" name="geraet" value="Laptop" x-model="data.geraet">
                          <span>Laptop</span>
                        </label>
                        <label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700"
                               :class="data.geraet==='MiniPC' ? 'ring-2 ring-primary' : ''"
                               @mouseenter="hover('MiniPC')" @mouseleave="hover(null)">
                          <input type="radio" name="geraet" value="MiniPC" x-model="data.geraet">
                          <span>Desktop (Mini-PC)</span>
                        </label>
                      </div>
                      <p class="mt-2 text-xs text-muted">Hinweis: Dockingstation nur bei Laptop relevant.</p>
                    </section>

                    <!-- 4: Peripherie (mit Docking-Regel + Warnung) -->
                    <section class="card card--pad" x-show="current===4">
                      <h4 class="font-semibold mb-2">üñ±Ô∏è Peripherie</h4>

                      <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <label class="flex items-center gap-2 cursor-pointer"
                               :class="(data.geraet==='MiniPC') ? 'opacity-50' : ''"
                               @mouseenter="hover('Dockingstation')" @mouseleave="hover(null)">
                          <input type="checkbox"
                                 x-model="data.artikel.Dockingstation"
                                 :disabled="data.geraet==='MiniPC' || data.dockingVorhanden">
                          <span>Dockingstation bestellen</span>
                        </label>

                        <label class="flex items-center gap-2 cursor-pointer"
                               :class="(data.geraet!=='Laptop') ? 'opacity-50' : ''">
                          <input type="checkbox"
                                 x-model="data.dockingVorhanden"
                                 :disabled="data.geraet!=='Laptop'"
                                 @change="if(data.dockingVorhanden){ data.artikel.Dockingstation=false; }">
                          <span>Dockingstation vorhanden (keine Bestellung n√∂tig)</span>
                        </label>
                      </div>

                      <template x-if="showDockingWarn">
                        <div class="mt-3 p-3 rounded-md border border-yellow-300 bg-yellow-50 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-200">
                          ‚ö†Ô∏è Bei <strong>2 Bildschirmen</strong> und <strong>Laptop</strong> ist eine Dockingstation
                          <em>Pflicht</em> ‚Äî bitte entweder ‚ÄûDockingstation bestellen‚Äú w√§hlen oder ‚ÄûDockingstation vorhanden‚Äú ankreuzen.
                        </div>
                      </template>

                      <div class="mt-4 grid grid-cols-2 gap-2">
                        <label class="flex items-center gap-2 cursor-pointer" @mouseenter="hover('MausUndTastatur')" @mouseleave="hover(null)">
                          <input type="checkbox" x-model="data.artikel.MausUndTastatur"><span>Maus &amp; Tastatur</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer" @mouseenter="hover('Headset')" @mouseleave="hover(null)">
                          <input type="checkbox" x-model="data.artikel.Headset"><span>Headset</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer" @mouseenter="hover('Webcam')" @mouseleave="hover(null)">
                          <input type="checkbox" x-model="data.artikel.Webcam"><span>Webcam</span>
                        </label>
                      </div>
                    </section>

                    <!-- 5: Mobilger√§t -->
                    <section class="card card--pad" x-show="current===5">
                      <h4 class="font-semibold mb-2">üì± Mobiles Ger√§t</h4>
                      <label class="flex items-center gap-2 cursor-pointer" @mouseenter="hover('HandyUndSim')" @mouseleave="hover(null)">
                        <input type="checkbox" x-model="data.artikel.HandyUndSim"><span>Handy &amp; SIM</span>
                      </label>
                    </section>

                    <!-- 6: Bemerkung -->
                    <section class="card card--pad" x-show="current===6">
                      <h4 class="font-semibold mb-2">üìù Optionale Bemerkung</h4>
                      <textarea class="field w-full" rows="3" x-model="data.bemerkung" placeholder="z. B. Standort, besondere Anforderungen ‚Ä¶"></textarea>
                    </section>

                    <!-- 7: Zusammenfassung -->
                    <section class="card card--pad" x-show="current===7">
                      <h4 class="font-semibold mb-2">üßæ Zusammenfassung</h4>
                      <div class="text-sm space-y-2">
                        <p><strong>Name:</strong> <span x-text="fullName"></span></p>
                        <p><strong>Firma:</strong> <span x-text="data.firma"></span> ¬∑ <strong>Kostenstelle:</strong> <span x-text="data.kostenstelle"></span></p>
                        <p><strong>Lieferadresse:</strong> <span x-text="assembledAddress"></span></p>
                        <p><strong>Lieferung bis:</strong> <span x-text="data.lieferungBis"></span></p>
                        <p><strong>Bildschirme:</strong> <span x-text="data.monitor.benoetigt ? data.monitor.anzahl : 'keine'"></span></p>
                        <p><strong>Ger√§t:</strong> <span x-text="data.geraet || '‚Äì'"></span></p>
                        <p><strong>Peripherie:</strong> <span x-text="listArtikel() || '‚Äì'"></span></p>
                        <template x-if="data.geraet==='Laptop'">
                          <p><strong>Docking vorhanden:</strong> <span x-text="data.dockingVorhanden ? 'Ja' : 'Nein'"></span></p>
                        </template>
                        <template x-if="data.bemerkung"><p><strong>Bemerkung:</strong> <span x-text="data.bemerkung"></span></p></template>
                      </div>
                    </section>
                  </div>
                </template>
              </div>

              <!-- Rechte Spalte: Vorschau nur in Hardware-Schritten -->
              <aside class="hidden lg:block" x-show="data.mitarbeiterTyp && current >= 2">
                <div class="sticky top-2">
                  <div class="card w-full h-[320px] flex items-center justify-center overflow-hidden">
                    <template x-if="previewUrls.length">
                      <img :src="previewUrls[previewIdx]" :alt="hoverKey || 'Preview'"
                           class="w-full h-full object-contain" @error="tryNextPreview()" />
                    </template>
                    <template x-if="!previewUrls.length">
                      <img src="/static/logo.png" alt="Logo" class="w-20 h-20 opacity-60">
                    </template>
                  </div>
                </div>
              </aside>
            </div>
          </form>
        </div>

        <!-- Footer -->
        <div class="px-6 py-3 border-t dark:border-gray-700">
          <div class="flex items-center justify-between min-h-[48px]">
            <div class="text-sm text-muted">
              <span x-text="`Schritt ${current+1} von ${steps.length}`"></span>
            </div>
            <div class="flex gap-2">
              <button type="button"
                      class="px-4 py-2 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600"
                      @click="prev()" :disabled="current===0">Zur√ºck</button>

              <button type="button"
                      x-show="!isLast"
                      class="px-4 py-2 rounded bg-primary hover:bg-primaryHover text-white disabled:opacity-50"
                      @click="next()" :disabled="!canProceed">Weiter</button>

              <button type="button"
                      x-show="isLast && current>0"
                      class="px-4 py-2 rounded bg-primary hover:bg-primaryHover text-white"
                      @click="submit()">Abschlie√üen &amp; Absenden</button>

              <button type="button"
                      class="px-4 py-2 rounded bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600"
                      @click="$dispatch('close-hw')">Abbrechen</button>
            </div>
          </div>
        </div>

      </div><!-- /Panel -->
    </div>
  </div>
</div>

<script>
function hwAssistant(){
  return {
    // --- State ---
    current: 0,
    error: '',
    steps: ['Mitarbeitertyp'],
    isLast: false,
    progress: 0,

    hoverKey: null,
    previewIdx: 0,
    previewUrls: [],
    imgMap: {
      Monitor:        ['Monitor.jpg','monitor.jpg'],
      Notebook:       ['Notebook.jpg','notebook.jpg'],
      MiniPC:         ['MiniPC.jpg','minipc.jpg'],
      Dockingstation: ['Dockingstation.jpg','dockingstation.jpg'],
      MausUndTastatur:['MausUndTastatur.jpg','mausundtastatur.jpg'],
      Headset:        ['Headset.jpg','headset.jpg'],
      Webcam:         ['Webcam.jpg','webcam.jpg'],
      HandyUndSim:    ['HandyUndSim.jpg','handyundsim.jpg']
    },

    companies: [],
    companiesLoading: false,
    companiesError: '',

    data: {},

    // --- Computeds ---
    get showDockingWarn(){
      return this.data.mitarbeiterTyp==='Neuer Mitarbeiter'
             && this.data.geraet==='Laptop'
             && this.data.monitor.benoetigt
             && Number(this.data.monitor.anzahl)===2
             && !this.data.dockingVorhanden
             && !this.data.artikel.Dockingstation;
    },
    get fullName(){
      return [this.data.vorname, this.data.nachname].map(s => (s||'').trim()).filter(Boolean).join(' ');
    },
    get assembledAddress(){
      const parts = [];
      const line1 = [this.data.addr_strasse, this.data.addr_nr].map(v=> (v||'').trim()).filter(Boolean).join(' ');
      if (line1) parts.push(line1);
      const line2 = [[this.data.addr_plz, this.data.addr_stadt].filter(Boolean).join(' ')].filter(Boolean).join('');
      if (line2) parts.push(line2);
      if ((this.data.addr_tuerschild||'').trim()) parts.push(`(T√ºrschild: ${this.data.addr_tuerschild.trim()})`);
      return parts.join(', ');
    },

    // --- Lifecycle ---
    async init(){
      this.resetHardware();
      this.fetchCompanies();

      this.$watch('current', () => this.recalcUi());
      this.$watch('data.mitarbeiterTyp', () => this.rebuildSteps());

      this.$watch('data.geraet', (v) => {
        if (v === 'Laptop') {
          this.data.artikel.Notebook = true;
          this.data.artikel.MiniPC = false;
        } else if (v === 'MiniPC') {
          this.data.artikel.MiniPC = true;
          this.data.artikel.Notebook = false;
          this.data.artikel.Dockingstation = false;
          this.data.dockingVorhanden = false;
        }
      });

      this.rebuildSteps();
      this.recalcUi();
    },

    // --- Firmen laden ---
    async fetchCompanies(){
      try{
        this.companiesLoading = true;
        this.companiesError = '';
        const res = await fetch('/api/companies', { headers: { 'Accept':'application/json' } });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const j = await res.json();
        this.companies = Array.isArray(j?.companies) ? j.companies : [];
      }catch(e){
        this.companiesError = 'Firmen konnten nicht geladen werden.';
        this.companies = [];
      }finally{
        this.companiesLoading = false;
      }
    },

    // --- UI helpers ---
    rebuildSteps(){
      const base = ['Mitarbeitertyp','Basisdaten'];
      this.steps = (!this.data.mitarbeiterTyp)
        ? ['Mitarbeitertyp']
        : (this.data.mitarbeiterTyp==='Bestandsmitarbeiter'
           ? [...base,'Auswahl & Grund','Zusammenfassung']
           : [...base,'Bildschirme','Ger√§t','Peripherie','Mobilger√§t','Bemerkung','Zusammenfassung']);
      if (this.current > this.steps.length-1) this.current = this.steps.length-1;
      this.recalcUi();
    },
    recalcUi(){
      const total = this.steps.length;
      this.progress = total<=1 ? 0 : Math.round((this.current)/(total-1)*100);
      this.isLast = (this.current === total-1);
    },

    // Preview
    hover(key){
      this.hoverKey = key;
      if (!key || !this.imgMap[key]) { this.previewUrls = []; this.previewIdx=0; return; }
      this.previewUrls = this.imgMap[key].map(f => `/static/${f}`);
      this.previewIdx = 0;
    },
    tryNextPreview(){
      if (!this.previewUrls.length) return;
      this.previewIdx = (this.previewIdx + 1) % this.previewUrls.length;
    },

    // Navigation
    next(){ if (this.canProceed) { this.error=''; this.current++; this.recalcUi(); } },
    prev(){ if (this.current>0) { this.current--; this.recalcUi(); } },

    // Validierung pro Schritt
    get canProceed(){
      const step = this.steps[this.current];
      const d = this.data;

      if (step==='Mitarbeitertyp') return !!d.mitarbeiterTyp;

      if (step==='Basisdaten'){
        // Pflichtfelder: Vorname, Nachname, Kostenstelle (digits), Firma, Adresse-Teile, Lieferung bis (>= +7d)
        if (!d.vorname || !d.nachname || !d.kostenstelle || !d.firma
            || !d.addr_strasse || !d.addr_nr || !d.addr_plz || !d.addr_stadt || !d.lieferungBis) return false;
        if (!/^\d+$/.test(d.kostenstelle)) return false;
        const sel = new Date(d.lieferungBis);
        const min = new Date(); min.setDate(min.getDate()+7);
        return sel >= new Date(min.getFullYear(), min.getMonth(), min.getDate());
      }

      if (d.mitarbeiterTyp==='Bestandsmitarbeiter'){
        if (step==='Auswahl & Grund'){
          const hatArtikel = Object.values(d.artikel).some(Boolean) || d.monitor.benoetigt;
          return hatArtikel && !!(d.grundBestellung||'').trim();
        }
        return true;
      } else {
        if (step==='Bildschirme') return true;
        if (step==='Ger√§t')      return !!d.geraet;

        if (step==='Peripherie'){
          if (d.geraet==='Laptop' && d.monitor.benoetigt && Number(d.monitor.anzahl)===2){
            return !!(d.artikel.Dockingstation || d.dockingVorhanden);
          }
          return true;
        }
        return true;
      }
    },

    listArtikel(){
      const map = {
        Notebook:'Notebook', MiniPC:'Mini-PC', Dockingstation:'Dockingstation',
        MausUndTastatur:'Maus & Tastatur', Headset:'Headset', Webcam:'Webcam', HandyUndSim:'Handy & SIM'
      };
      return Object.entries(this.data.artikel).filter(([,v])=>v).map(([k])=>map[k]).join(', ');
    },

    // Submit
    submit(){
      if (!this.canProceed) { this.error='Bitte Schritt vervollst√§ndigen.'; return; }
      const sel = new Date(this.data.lieferungBis);
      const min = new Date(); min.setDate(min.getDate()+7);
      if (sel < new Date(min.getFullYear(),min.getMonth(),min.getDate())){
        this.error = 'üö´ Lieferung muss mindestens 7 Tage Vorlauf haben!'; return;
      }

      const d = this.data;

      // Zusammensetzen f√ºr Backend (Format beibehalten!)
      const name = [d.vorname, d.nachname].map(s=> (s||'').trim()).filter(Boolean).join(' ');
      const addrParts = [];
      const line1 = [d.addr_strasse, d.addr_nr].map(v=>(v||'').trim()).filter(Boolean).join(' ');
      if (line1) addrParts.push(line1);
      const line2 = [[d.addr_plz, d.addr_stadt].filter(Boolean).join(' ')].filter(Boolean).join('');
      if (line2) addrParts.push(line2);
      if ((d.addr_tuerschild||'').trim()) addrParts.push(`(T√ºrschild: ${d.addr_tuerschild.trim()})`);
      const adresse = addrParts.join(', ');

      const payload = {
        ticketType: 'Hardwarebestellung',
        data: {
          MitarbeiterTyp: d.mitarbeiterTyp,
          Name: name,                                   // zusammengesetzt
          Kostenstelle: d.kostenstelle,
          Firma: d.firma,
          Lieferadresse: adresse,                       // zusammengesetzt
          Lieferung_bis: d.lieferungBis,
          Monitor: { benoetigt: d.monitor.benoetigt, Anzahl: d.monitor.anzahl },
          Geraet: d.geraet || null,
          Artikel: { ...d.artikel },
          Dockingstation_vorhanden: !!d.dockingVorhanden,
          Bemerkung: d.bemerkung || null,
          GrundNeubestellung: d.mitarbeiterTyp==='Bestandsmitarbeiter' ? (d.grundBestellung||'') : null
        }
      };

      if (d.geraet==='MiniPC'){ payload.data.Artikel.Dockingstation = false; payload.data.Dockingstation_vorhanden = false; }

      this.$refs.desc.value = JSON.stringify(payload);
      this.$refs.form.submit();

      this.resetAll();
      this.$dispatch('close-hw');
    },

    // Reset
    resetAll(){ this.current=0; this.error=''; this.hoverKey=null; this.previewUrls=[]; this.previewIdx=0; this.resetHardware(); },
    resetHardware(){
      const d = new Date(); d.setDate(d.getDate()+7);
      this.data = {
        mitarbeiterTyp:'',
        vorname:'', nachname:'',
        kostenstelle:'', firma:'',
        // Adresse-Teile
        addr_strasse:'', addr_nr:'', addr_plz:'', addr_stadt:'', addr_tuerschild:'',
        lieferungBis: d.toISOString().split('T')[0],
        monitor:{ benoetigt:false, anzahl:1 },
        geraet:'',
        artikel:{
          Notebook:false, MiniPC:false, Dockingstation:false,
          MausUndTastatur:false, Headset:false, Webcam:false, HandyUndSim:false
        },
        dockingVorhanden:false,
        bemerkung:'',
        grundBestellung:''
      };
      this.rebuildSteps();
      this.recalcUi();
    }
  }
}
</script>
