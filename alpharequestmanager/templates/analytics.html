{% extends "base.html" %}
{% block title %}Analytics â€“ AlphaRequestManager{% endblock %}

{% block head %}
<style>
  .chart-area{height:280px;position:relative}
  @media (min-width:1024px){.chart-area{height:320px}}
  .nice-scrollbar{scrollbar-width:thin; scrollbar-color: rgba(0,0,0,.2) transparent}
  .nice-scrollbar::-webkit-scrollbar{height:8px;width:8px}
  .nice-scrollbar::-webkit-scrollbar-thumb{background:rgba(0,0,0,.25);border-radius:8px}
  .nice-scrollbar::-webkit-scrollbar-track{background:transparent}
  .skeleton{position:relative;overflow:hidden;background:#e5e7eb;border-radius:12px}
  .skeleton.line{height:12px;margin:8px 0;border-radius:6px}
  .skeleton.block{height:220px}
  .skeleton::after{content:"";position:absolute;inset:0;transform:translateX(-100%);
    background:linear-gradient(90deg, transparent, rgba(255,255,255,.45), transparent);
    animation:shimmer 1.2s infinite}
  @keyframes shimmer{100%{transform:translateX(100%)}}
  .hidden{display:none}
</style>
<link rel="icon" href="data:,"> <!-- Favicon-Fix -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<!-- Optional: dezente Wertebeschriftungen -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
  if (window.ChartDataLabels) { Chart.register(ChartDataLabels); }
</script>
{% endblock %}

{% block content %}
<div class="min-h-[80vh]">
  <!-- Header -->
  <header class="mb-6">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow border border-gray-100 dark:border-gray-700 px-4 sm:px-6 py-4">
      <div class="flex items-center justify-between flex-wrap gap-3">
        <h1 class="text-xl sm:text-2xl font-bold">Analytics</h1>
        <form id="filters" class="flex items-end gap-2 flex-wrap">
          <div>
            <label for="df" class="block text-xs text-gray-500">Von</label>
            <input id="df" type="date" class="px-2 py-1 rounded-md bg-gray-100 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 focus:outline-none"/>
          </div>
          <div>
            <label for="dt" class="block text-xs text-gray-500">Bis</label>
            <input id="dt" type="date" class="px-2 py-1 rounded-md bg-gray-100 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 focus:outline-none"/>
          </div>
          <div class="flex gap-1">
            <button type="button" data-range="7" class="px-2 py-1 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-md">7T</button>
            <button type="button" data-range="30" class="px-2 py-1 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-md">30T</button>
            <button type="button" data-range="90" class="px-2 py-1 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-md">90T</button>
          </div>
          <button id="apply" type="button" class="px-3 py-1.5 bg-primary text-white rounded-md hover:bg-primaryHover focus:outline-none">Aktualisieren</button>
        </form>
      </div>
    </div>
  </header>

  <!-- Cards -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Gesamt mit Status -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow border border-gray-100 dark:border-gray-700 p-5">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Gesamt</h3>
      </div>
      <div id="sk-total">
        <div class="skeleton line" style="width:40%"></div>
        <div class="skeleton line" style="width:60%"></div>
        <div class="skeleton line" style="width:50%"></div>
      </div>
      <div id="ct-total" class="hidden">
        <div class="text-4xl font-bold mt-2" id="total">â€“</div>
        <p class="text-sm text-gray-500 mt-1">Gefilterter Zeitraum</p>
        <div class="mt-4 grid grid-cols-3 gap-2 text-sm">
          <div class="rounded-lg bg-yellow-100 text-yellow-900 dark:bg-yellow-900/30 dark:text-yellow-100 px-3 py-2">
            <div class="font-medium">Ausstehend</div>
            <div id="st-pending" class="text-lg font-bold">â€“</div>
          </div>
          <div class="rounded-lg bg-green-100 text-green-900 dark:bg-green-900/30 dark:text-green-100 px-3 py-2">
            <div class="font-medium">Genehmigt</div>
            <div id="st-approved" class="text-lg font-bold">â€“</div>
          </div>
          <div class="rounded-lg bg-red-100 text-red-900 dark:bg-red-900/30 dark:text-red-100 px-3 py-2">
            <div class="font-medium">Abgelehnt</div>
            <div id="st-rejected" class="text-lg font-bold">â€“</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tickets nach Typ -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow border border-gray-100 dark:border-gray-700 p-5">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Tickets nach Typ</h3>
      </div>
      <div id="sk-type">
        <div class="skeleton block"></div>
        <div class="skeleton line" style="width:65%"></div>
        <div class="skeleton line" style="width:35%"></div>
      </div>
      <div id="ct-type" class="hidden">
        <div class="chart-area"><canvas id="chartType"></canvas></div>
        <div class="mt-3 max-h-40 overflow-auto nice-scrollbar">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="border-b border-gray-200 dark:border-gray-700 text-left">
                <th class="py-1 pr-2">Typ</th>
                <th class="py-1 text-right">Anzahl</th>
              </tr>
            </thead>
            <tbody id="tblType"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tickets pro Tag -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow border border-gray-100 dark:border-gray-700 p-5">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Tickets pro Tag</h3>
      </div>
      <div id="sk-date">
        <div class="skeleton block"></div>
        <div class="skeleton line" style="width:50%"></div>
      </div>
      <div id="ct-date" class="hidden">
        <div class="chart-area"><canvas id="chartDate"></canvas></div>
        <div class="mt-3 max-h-40 overflow-auto nice-scrollbar">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="border-b border-gray-200 dark:border-gray-700 text-left">
                <th class="py-1 pr-2">Datum</th>
                <th class="py-1 text-right">Anzahl</th>
              </tr>
            </thead>
            <tbody id="tblDate"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Top Hardware (horizontale Rangliste) -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow border border-gray-100 dark:border-gray-700 p-5">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Top Hardware</h3>
      </div>
      <div id="sk-hw">
        <div class="skeleton block"></div>
        <div class="skeleton line" style="width:60%"></div>
      </div>
      <div id="ct-hw" class="hidden">
        <div class="chart-area"><canvas id="chartHw"></canvas></div>
        <div class="mt-3 max-h-40 overflow-auto nice-scrollbar">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="border-b border-gray-200 dark:border-gray-700 text-left">
                <th class="py-1 pr-2">Artikel</th>
                <th class="py-1 text-right">Menge</th>
              </tr>
            </thead>
            <tbody id="tblHw"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  let chartType, chartDate, chartHw;

  function show(idSk, idCt){ $(idSk).classList.add('hidden'); $(idCt).classList.remove('hidden'); }
  function hide(idSk, idCt){ $(idSk).classList.remove('hidden'); $(idCt).classList.add('hidden'); }

  // Modernisierte Chart-Factory
  function mkChart(el, type, labels, rawData){
    const ctx = el.getContext('2d');
    const data = rawData.map(v => Number(v) || 0);
    const max = Math.max(0, ...data);
    const sum = data.reduce((a,b)=>a+b,0) || 1;

    const brand = { base: 'rgb(37,99,235)', fill: 'rgba(37,99,235,0.15)', bar: 'rgba(37,99,235,0.35)' };
    const palette = [
      'rgb(37,99,235)','rgb(16,185,129)','rgb(234,179,8)','rgb(244,63,94)',
      'rgb(99,102,241)','rgb(14,165,233)','rgb(163,163,163)'
    ];

    const grad = (() => {
      const g = ctx.createLinearGradient(0, 0, 0, el.height);
      g.addColorStop(0, brand.fill);
      g.addColorStop(1, 'rgba(37,99,235,0)');
      return g;
    })();

    const baseOptions = {
      responsive: true,
      maintainAspectRatio: false,
      normalized: true,
      spanGaps: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const v = ctx.raw ?? ctx.parsed;
              if (type === 'doughnut') {
                const pct = ((v / sum) * 100).toFixed(1);
                return `${ctx.label}: ${v} (${pct}%)`;
              }
              if (type === 'bar' && ctx.chart?.options?.indexAxis === 'y') {
                const pct = ((v / sum) * 100).toFixed(1);
                return `${ctx.label}: ${v} (${pct}%)`;
              }
              return `${v}`;
            }
          }
        },
        datalabels: (type === 'line') ? false : {
          anchor: 'end',
          align: 'end',
          offset: 4,
          formatter: (v, ctx) => {
            if (type === 'doughnut') {
              const pct = (v / sum) * 100;
              return pct >= 6 ? `${v}` : '';
            }
            return v;
          },
          font: { weight: '600' }
        }
      },
      scales: (type === 'doughnut') ? {} : {
        x: {
          ticks: { autoSkip: true, maxTicksLimit: 10 },
          grid: { color: 'rgba(0,0,0,0.06)' }
        },
        y: {
          beginAtZero: true,
          suggestedMax: (max || 1) + 1,
          ticks: { precision: 0 },
          grid: { color: 'rgba(0,0,0,0.06)' }
        }
      }
    };

    const config = { type, data: { labels, datasets: [] }, options: baseOptions };

    if (type === 'line') {
      config.data.datasets.push({
        data, label: '', tension: 0.35, fill: true,
        borderColor: brand.base, backgroundColor: grad,
        pointRadius: 2.5, pointBackgroundColor: brand.base, borderWidth: 2
      });
    } else if (type === 'bar') {
      config.data.datasets.push({
        data, label: '',
        borderColor: brand.base, backgroundColor: brand.bar,
        borderWidth: 1, borderRadius: 6, barThickness: 'flex'
      });
    } else if (type === 'doughnut') {
      config.data.datasets.push({
        data, label: '',
        backgroundColor: labels.map((_, i) => palette[i % palette.length]),
        borderWidth: 0, hoverOffset: 4
      });
      config.options.cutout = '62%';
    }

    return new Chart(el, config);
  }

  function fillTable(tbody, rows){
    tbody.innerHTML = rows.map(([k,v]) => (
      `<tr class="border-b border-gray-100 dark:border-gray-700"><td class="py-1 pr-2">${k}</td><td class="py-1 text-right">${v}</td></tr>`
    )).join('');
  }

  function setRange(days){
    const dt = new Date();
    const to = dt.toISOString().slice(0,10);
    dt.setDate(dt.getDate() - days);
    const from = dt.toISOString().slice(0,10);
    $('#df').value = from; $('#dt').value = to;
  }

  async function load(){
    hide('#ct-total','#sk-total'); hide('#ct-type','#sk-type'); hide('#ct-date','#sk-date'); hide('#ct-hw','#sk-hw');

    const df = $('#df').value; const dt = $('#dt').value;
    const qs = (p)=> Object.entries(p).filter(([,v])=>v).map(([k,v])=>`${k}=${encodeURIComponent(v)}`).join('&');

    const [ovr, hw] = await Promise.all([
      fetch(`/api/analytics/overview?${qs({date_from: df, date_to: dt})}`).then(r=>r.json()),
      fetch(`/api/analytics/hardware/top?${qs({date_from: df, date_to: dt, limit: 12})}`).then(r=>r.json())
    ]);

    // Gesamt
    $('#total').textContent = String(ovr.total_tickets || 0);
    const sMap = Object.fromEntries((ovr.by_status||[]).map(x=>[x.status, x.count]));
    $('#st-pending').textContent = sMap.pending ?? 0;
    $('#st-approved').textContent = sMap.approved ?? 0;
    $('#st-rejected').textContent = sMap.rejected ?? 0;
    show('#sk-total', '#ct-total');

    // Typ (Donut)
    const rowsType = (ovr.by_type || []).map(x=>[x.type, Number(x.count)||0]);
    fillTable($('#tblType'), rowsType);
    show('#sk-type', '#ct-type');
    if(chartType) chartType.destroy();
    chartType = mkChart($('#chartType'), 'doughnut', rowsType.map(r=>r[0]), rowsType.map(r=>r[1]));
    setTimeout(() => { try { chartType.resize(); } catch(e) { console.error(e); } }, 50);

    // Datum (Area-Line)
    const rowsDate = (ovr.by_date || []).map(x=>[x.date, Number(x.count)||0]);
    if (rowsDate.length === 0) {
      $('#ct-date').innerHTML = '<p class="text-center text-gray-500 py-10">ðŸ“‰ Keine Daten fÃ¼r diesen Zeitraum.</p>';
    } else {
      fillTable($('#tblDate'), rowsDate);
      show('#sk-date', '#ct-date');
      if (chartDate) chartDate.destroy();

      let labels = rowsDate.map(r => r[0]);
      let data = rowsDate.map(r => r[1]);
      if (labels.length === 1) { labels = [labels[0], labels[0]]; data = [data[0], data[0]]; }

      chartDate = mkChart($('#chartDate'), 'line', labels, data);
      setTimeout(() => { try { chartDate.resize(); } catch(e) { console.error(e); } }, 50);
    }

    // Hardware (horizontale Rangliste)
    const rowsHw = (hw || []).map(x=>[x.item, Number(x.quantity)||0]);
    if (rowsHw.length === 0) {
      $('#ct-hw').innerHTML = '<p class="text-center text-gray-500 py-10">ðŸ§± Keine Hardware-Daten im Zeitraum.</p>';
    } else {
      const short = s => s.length > 28 ? s.slice(0,25) + 'â€¦' : s;
      const sorted = rowsHw.sort((a,b)=> b[1]-a[1]);

      fillTable($('#tblHw'), sorted);
      show('#sk-hw', '#ct-hw');
      if(chartHw) chartHw.destroy();

      let labels = sorted.map(r => short(r[0]));
      let data = sorted.map(r => r[1]);
      if (labels.length === 1) { labels = [labels[0], labels[0]]; data = [data[0], data[0]]; }

      const el = $('#chartHw');
      chartHw = new Chart(el, {
        type: 'bar',
        data: { labels, datasets: [{
          data, borderWidth: 1, borderRadius: 8,
          backgroundColor: 'rgba(37,99,235,0.35)', borderColor: 'rgb(37,99,235)'
        }]},
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const v = ctx.raw;
                  const total = data.reduce((a,b)=>a+b,0) || 1;
                  const pct = ((v/total)*100).toFixed(1);
                  return `${v} (${pct}%)`;
                }
              }
            },
            datalabels: {
              anchor: 'end', align: 'end', offset: 4,
              formatter: v => v, font: { weight: '600' }
            }
          },
          scales: {
            x: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.06)' }, ticks: { precision: 0 } },
            y: { grid: { display: false } }
          }
        }
      });

      setTimeout(() => { try { chartHw.resize(); } catch(e) { console.error(e); } }, 50);
    }
  }

  $('#apply').addEventListener('click', load);
  $$('#filters [data-range]').forEach(btn=> btn.addEventListener('click', ()=>{ setRange(parseInt(btn.dataset.range,10)); load(); }));
  document.addEventListener('DOMContentLoaded', ()=>{ setRange(30); load(); });
</script>
{% endblock %}
