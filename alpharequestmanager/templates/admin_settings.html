{% extends "base.html" %}
{% block title %}Admin · Settings{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-8">

  <!-- Header -->
  <header class="space-y-1">
    <h1 class="text-3xl font-bold">Admin · Settings</h1>
    <p class="text-sm text-gray-600 dark:text-gray-300">
      Passe Anwendungs- und Azure-Einstellungen an. Änderungen werden in der Datenbank gespeichert.
    </p>
  </header>

  <!-- Restart-Hinweis -->
  <div id="restart-banner"
       class="hidden rounded-lg border border-yellow-300/60 bg-yellow-50 dark:bg-yellow-900/20 text-yellow-900 dark:text-yellow-100 px-4 py-3 text-sm">
    Änderungen am <strong>SESSION_TIMEOUT</strong> werden erst <strong>nach einem Neustart</strong> der Anwendung wirksam.
  </div>

  <!-- KPI Cards -->
  <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-5">
      <div class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Zur Laufzeit aktiv</div>
      <div id="runtime-timeout" class="mt-1 text-3xl font-semibold">
        {{ settings.runtime_session_timeout if settings.runtime_session_timeout is defined else settings.SESSION_TIMEOUT }}
      </div>
      <div class="text-sm text-gray-500 dark:text-gray-400">SESSION_TIMEOUT (Sekunden)</div>
    </div>

    <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-5">
      <div class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Konfiguriert (DB)</div>
      <div id="configured-timeout" class="mt-1 text-3xl font-semibold">
        {{ settings.SESSION_TIMEOUT }}
      </div>
      <div class="text-sm text-gray-500 dark:text-gray-400">SESSION_TIMEOUT (Sekunden)</div>
    </div>
  </section>

  <!-- Toast -->
  <div id="toast"
       class="hidden fixed top-6 right-6 z-[60] rounded-lg border px-4 py-3 text-sm shadow-lg"
       role="status" aria-live="polite"></div>

  <!-- Form -->
  <form id="settings-form" onsubmit="return false;" class="space-y-6">

    <!-- Microsoft / Auth -->
    <section class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
      <div class="border-b border-gray-200 dark:border-gray-700 px-5 py-4">
        <h2 class="text-lg font-semibold">Microsoft / Auth</h2>
      </div>
      <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4">

        <label class="block">
          <span class="block text-sm font-medium mb-1">CLIENT_ID</span>
          <input name="CLIENT_ID" type="text" value="{{ settings.CLIENT_ID or '' }}"
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-fieldDark text-gray-900 dark:text-gray-100 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" />
        </label>

        <label class="block">
          <span class="block text-sm font-medium mb-1">CLIENT_SECRET</span>
          <input name="CLIENT_SECRET" type="password" placeholder="••••••••"
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-fieldDark text-gray-900 dark:text-gray-100 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" />
          <span class="mt-1 block text-xs text-gray-500 dark:text-gray-400">Leer lassen = unverändert</span>
        </label>

        <label class="block">
          <span class="block text-sm font-medium mb-1">TENANT_ID</span>
          <input name="TENANT_ID" type="text" value="{{ settings.TENANT_ID or '' }}"
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-fieldDark text-gray-900 dark:text-gray-100 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" />
        </label>

        <label class="block">
          <span class="block text-sm font-medium mb-1">AUTHORITY (optional Override)</span>
          <input name="AUTHORITY" type="url" placeholder="{{ settings.AUTHORITY }}"
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-fieldDark text-gray-900 dark:text-gray-100 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" />
          <span class="mt-1 block text-xs text-gray-500 dark:text-gray-400">Normalerweise automatisch aus TENANT_ID</span>
        </label>

        <label class="block md:col-span-2">
          <span class="block text-sm font-medium mb-1">REDIRECT_URI</span>
          <input name="REDIRECT_URI" type="url" value="{{ settings.REDIRECT_URI or '' }}"
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-fieldDark text-gray-900 dark:text-gray-100 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" />
        </label>

        <label class="block md:col-span-2">
          <span class="block text-sm font-medium mb-1">SCOPE (CSV)</span>
          <input name="SCOPE" type="text" value="{{ settings.SCOPE | join(',') }}"
                 placeholder="openid, profile, email"
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-fieldDark text-gray-900 dark:text-gray-100 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" />
        </label>

        <label class="block md:col-span-2">
          <span class="block text-sm font-medium mb-1">ADMIN_GROUP_ID</span>
          <input name="ADMIN_GROUP_ID" type="text" value="{{ settings.ADMIN_GROUP_ID or '' }}"
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-fieldDark text-gray-900 dark:text-gray-100 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" />
        </label>

      </div>
    </section>

    <!-- App -->
    <section class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
      <div class="border-b border-gray-200 dark:border-gray-700 px-5 py-4">
        <h2 class="text-lg font-semibold">App</h2>
      </div>
      <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4">

        <label class="block md:col-span-2">
          <span class="block text-sm font-medium mb-1">SECRET_KEY</span>
          <input name="SECRET_KEY" type="password" placeholder="••••••••"
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-fieldDark text-gray-900 dark:text-gray-100 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" />
          <span class="mt-1 block text-xs text-gray-500 dark:text-gray-400">Ändern invaldiert existierende Sessions</span>
        </label>

        <label class="block md:col-span-2">
          <span class="block text-sm font-medium mb-1">TICKET_MAIL</span>
          <input name="TICKET_MAIL" type="email" value="{{ settings.TICKET_MAIL or '' }}"
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-fieldDark text-gray-900 dark:text-gray-100 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" />
        </label>

        <label class="block md:col-span-2">
          <span class="block text-sm font-medium mb-1">SESSION_TIMEOUT (Sekunden)</span>
          <input name="SESSION_TIMEOUT" type="number" min="60" max="{{ 24*60*60 }}" value="{{ settings.SESSION_TIMEOUT }}"
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-fieldDark text-gray-900 dark:text-gray-100 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" />
          <span class="mt-1 block text-xs text-gray-500 dark:text-gray-400">Wirkt ohne Cookie-Refresh erst nach Neustart.</span>
        </label>

      </div>
    </section>

    <!-- Actions -->
    <div class="flex items-center justify-end gap-3">
      <button id="btn-save" type="button"
              class="inline-flex items-center gap-2 rounded-lg bg-primary px-5 py-2.5 text-white font-medium hover:bg-primaryHover transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M5 12.5l4 4L19 7"/></svg>
        Speichern
      </button>
    </div>

  </form>
</div>

<script>
  async function fetchSettings() {
    try {
      const res = await fetch("/api/admin/settings", { credentials: "same-origin" });
      if (!res.ok) return;
      const s = await res.json();
      if (typeof s.runtime_session_timeout !== "undefined") {
        document.getElementById("runtime-timeout").textContent = s.runtime_session_timeout;
      }
      if (typeof s.SESSION_TIMEOUT !== "undefined") {
        document.getElementById("configured-timeout").textContent = s.SESSION_TIMEOUT;
      }
    } catch (e) {
      /* optional: silently ignore */
    }
  }

  async function saveSettings() {
    const form = document.getElementById('settings-form');
    const data = Object.fromEntries(new FormData(form).entries());

    // leere Secrets nicht senden => bleiben unverändert
    if (!data.SECRET_KEY) delete data.SECRET_KEY;
    if (!data.CLIENT_SECRET) delete data.CLIENT_SECRET;
    if (!data.AUTHORITY) delete data.AUTHORITY;

    // Normalisieren
    if (typeof data.SESSION_TIMEOUT !== "undefined" && data.SESSION_TIMEOUT !== "") {
      data.SESSION_TIMEOUT = Number(data.SESSION_TIMEOUT);
    } else {
      delete data.SESSION_TIMEOUT;
    }

    if (typeof data.SCOPE === "string") {
      data.SCOPE = data.SCOPE.split(",").map(s => s.trim()).filter(Boolean);
    }

    // Leere Strings entfernen (keine Änderungen)
    Object.keys(data).forEach(k => { if (data[k] === "") delete data[k]; });

    try {
      const res = await fetch("/api/admin/settings", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
        credentials: "same-origin",
      });
      const json = await res.json();
      if (!res.ok || json.ok === false) throw new Error(json.detail || "Fehler beim Speichern");

      // UI aktualisieren
      document.getElementById("configured-timeout").textContent = json.settings.SESSION_TIMEOUT;
      if (typeof json.runtime_session_timeout !== "undefined") {
        document.getElementById("runtime-timeout").textContent = json.runtime_session_timeout;
      }

      // Neustart-Hinweis
      if (json.restart_required) {
        document.getElementById("restart-banner").classList.remove('hidden');
        toast("Gespeichert. Neustart erforderlich, damit SESSION_TIMEOUT greift.", true);
      } else {
        toast("Gespeichert.", true);
      }
    } catch (e) {
      toast(e.message || "Fehler", false);
    }
  }

  function toast(msg, ok) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = "fixed top-6 right-6 z-[60] rounded-lg border px-4 py-3 text-sm shadow-lg " +
      (ok
        ? "bg-emerald-50 dark:bg-emerald-900/20 border-emerald-300/60 text-emerald-900 dark:text-emerald-100"
        : "bg-red-50 dark:bg-red-900/20 border-red-300/60 text-red-900 dark:text-red-100");
    t.classList.remove('hidden');
    setTimeout(() => t.classList.add('hidden'), 3000);
  }

  document.getElementById('btn-save').addEventListener('click', saveSettings);
  document.addEventListener('DOMContentLoaded', fetchSettings);
</script>
{% endblock %}
